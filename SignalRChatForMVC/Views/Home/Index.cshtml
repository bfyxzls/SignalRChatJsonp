@{
    ViewBag.Title = "Index";
}

<h2>SignalR在线聊天，基于websocket</h2>
@if (Session["userID"] == null)
{
    <div>
        您还没有登陆，请先<a href="/home/login">登陆</a>
    </div> 
}
else
{
    <div>
        <!--Reference the jQuery library. -->
        <script src="/Scripts/jquery-1.8.2.min.js"></script>

        <!--Reference the SignalR library. -->
        <script src="/Scripts/jquery.signalR-1.0.0.js"></script>
        <!--Reference the autogenerated SignalR hub script. -->
        <script src="/signalr/hubs"></script>

        <script type="text/javascript">
            $(function () {
                // Declare a proxy to reference the hub
                var chatHub = $.connection.UrlHubZzl;
                registerClientMethods(chatHub);
                // Start Hub
                $.connection.hub.start().done(function () {
                    registerEvents(chatHub);
                });

            });

            //注册客户端事件
            function registerEvents(chatHub) {
                $("#btn").click(function () {
                    chatHub.server.connect($("#userID").val());
                });

                $("#logOut").click(function () {
                    chatHub.server.exit($("#loginUserID").html());
                });

                $("#sendmessage").click(function () {
                    chatHub.server.message($("#loginUserID").html(), $("#toUser").val(), $("#message").val());
                });
            }

            //注册客户端方法
            function registerClientMethods(chatHub) {

                chatHub.client.onConnected = function (id, userID, url) {
                    console.log("与服务器建立了链接,链接ID" + id);
                }

                chatHub.client.onUserDisconnected = function (id, userID) {
                    console.log("与服务器取消了链接");
                }

                chatHub.client.onNewUserConnected = function (userID) {
                    $("#login").hide();
                    $("#logout").show();
                    $("#loginUserID").html(userID);

                }

                chatHub.client.onExistUserConnected = function (id, userID) {
                    alert("用户" + userID + "已经登陆！");
                }

                chatHub.client.onExit = function (userID) {
                    $("#login").show();
                    $("#logout").hide();
                }
                chatHub.client.onUserList = function (allUsers) {
                    $("#userList").empty();
                    for (i = 0; i < allUsers.length; i++) {
                        $("#userList").append("连接ＩＤ：" + allUsers[i].ConnectionId + "，用户ＩＤ：" + allUsers[i].UserID + "<br/>");
                    }
                }
                chatHub.client.onMessage = function (count) {
                    $("#xiaoxi").html(count);
                }

                chatHub.client.onMessageList = function (object) {
                    $("#messageList").empty();
                    for (i = 0; i < object.length; i++) {
                        $("#messageList").append(object[i].ToUser + ":" + object[i].Info + "<br/>");
                    }
                }


                chatHub.client.onMessageError = function (message) {
                    alert(message);
                }
            }

        </script>

        <div id="login">
            <input type="hidden" value="@Session["userID"]" id="userID" />
            <input id="btn" type="button" value="开始聊天..." class="submitButton" />
        </div>
        <div id="logout" style="display: none">
            欢迎您：<span id="loginUserID"></span>
            <div>您有(<span id="xiaoxi">0</span>)个新消息</div>
            <div id="messageList"></div>
            <input id="logOut" type="button" value="登出" class="submitButton" />

            <input id="toUser" type="text" value="给谁发" /><input type="text" value="发的内容" id="message" /><input type="button" id="sendmessage" value="为他发消息" />
            <p>当前登陆的用户列表：</p>
            <p id="userList"></p>
        </div>
    </div>
}
