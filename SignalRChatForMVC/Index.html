<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

    <title></title>
    <!--Reference the jQuery library. -->
    <script src="http://www.lind.com/Scripts/jquery-1.8.2.min.js"></script>

    <!--Reference the SignalR library. -->
    <script src="http://www.lind.com/Scripts/jquery.signalR-2.0.0.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="http://www.lind.com/signalr/hubs"></script>
    <style type="text/css">
        #userList, #messageList {
            font-size: 12px;
            font-family: 宋体;
        }
    </style>
    <script type="text/javascript">
        $(function () {
            // Declare a proxy to reference the hub
            var chatHub = $.connection.UrlHubZzl;
            registerClientMethods(chatHub);
            // Start Hub
            $.connection.hub.url = "http://www.lind.com/signalr";
            $.connection.hub.start().done(function () {
                registerEvents(chatHub);
            });

        });

        //注册客户端事件
        function registerEvents(chatHub) {

            //用户登陆
            $("#btn").click(function () {
                $.ajax({
                    type: "GET",
                    dataType: "jsonp",
                    url: "http://www.lind.com/home/AjaxLogin",
                    jsonpCallback: "flightHandler",
                    data: { userName: $("#userName").val(), password: $("#password").val() },
                    success: function (data) {
                        if (data.flag) {
                            console.log(data.token)
                            chatHub.server.connect(data.token);
                        }
                        else {
                            alert("登陆失败")
                            console.log("error");
                        }

                    }
                })
            });

            //登出
            $("#logOut").click(function () {
                chatHub.server.exit($("#loginUserID").html());
            });

            //发消息
            $("#sendmessage").click(function () {
                chatHub.server.message($("#loginUserID").html(), $("#toUser").val(), $("#message").val());
            });
        }

        //注册客户端方法
        function registerClientMethods(chatHub) {

            chatHub.client.onConnected = function (id, token, url) {
                console.log("与服务器建立了链接,链接ID" + id);
            }

            chatHub.client.onUserDisconnected = function (id, token) {
                console.log("与服务器取消了链接");
            }

            chatHub.client.onNewUserConnected = function (token) {
                $("#login").hide();
                $("#logout").show();
                $("#loginUserID").html(token);

            }``

            chatHub.client.onExistUserConnected = function (id, token) {
                alert("用户" + userID + "已经登陆！");
            }

            chatHub.client.onExit = function (userID) {
                $("#login").show();
                $("#logout").hide();
            }
            chatHub.client.onUserList = function (allUsers) {
                $("#userList").empty();
                for (i = 0; i < allUsers.length; i++) {
                    $("#userList").append("连接ID：" + allUsers[i].ConnectionId + "，用户标识：" + allUsers[i].Token + "，用户昵称：" + allUsers[i].UserName + "<br/>");
                    $("#toUser").append("<option value='" + allUsers[i].Token + "'>" + allUsers[i].UserName + "</option>");
                }
            }
            chatHub.client.onMessage = function (count) {
                $("#xiaoxi").html(count);
            }

            chatHub.client.onMessageList = function (object) {
                $("#messageList").empty();
                for (i = 0; i < object.length; i++) {
                    $("#messageList").append(object[i].ToUser + ":" + object[i].Info + "<br/>");
                }
            }


            chatHub.client.onMessageError = function (message) {
                alert(message);
            }
        }

    </script>

</head>
<body>
    <div id="login">
        用户名：<input type="text" value="lind" id="userName" /><br />
        密码：<input type="text" value="123456" id="password" /><br />
        <input id="btn" type="button" value="登陆" class="submitButton" />
    </div>
    <div id="logout" style="display: none">
        欢迎您：<span id="loginUserID"></span>
        <hr />
        <p>当前登陆的用户列表：</p>
        <p id="userList"></p>
        <hr />
        <div>您有(<span id="xiaoxi">0</span>)个新消息</div>
        <div id="messageList"></div>
        <hr />
        <input id="logOut" type="button" value="登出" class="submitButton" />
        发给谁：
        <select id="toUser"></select>
        <input type="text" value="发的内容" id="message" />
        <input type="button" id="sendmessage" value="为他发消息" />

    </div>
</body>
</html>
